#!/bin/bash

function bindir {
    if [ "$PLATFORM" == "linux" ]; then
        echo "bin"
    elif [ "$PLATFORM" == "windows" ]; then
        echo "Scripts"
    else
        echo ""
    fi
}

# Script instructions

COMMAND="$1"
ROOTDIR="$(dirname $(dirname $0))"

source "$ROOTDIR/bin/env"

cd $ROOTDIR
cd server

# Initialize a virtual environment

if [ "$COMMAND" == "setup" ]; then
    BINDIR="$(bindir)"

    if [ ! -d "venv" ] && [ -f "requirements.txt" ] && [ "$BINDIR" ]; then
        virtualenv venv
        source "venv/$BINDIR/activate"
        pip install -r requirements.txt
    fi

# Install dependencies

elif [ "$COMMAND" == "install" ]; then
    if [ -d "venv" ]; then
        source venv/bin/activate

        ARGS="${@:2}"

        if [ ! "$ARGS" ] && [ -f "requirements.txt" ]; then
            pip install -r requirements.txt

        elif [ "$ARGS" ]; then
            pip install $ARGS
            pip freeze > requirements.txt
        fi
    fi

# Initialize and startup the app server

elif [ "$COMMAND" == "run" ]; then
    python manage.py migrate
    python manage.py runserver 0.0.0.0:8000

fi
